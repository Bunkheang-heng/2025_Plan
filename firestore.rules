rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() { return request.auth != null; }
    function hardAdminByEmail() {
      // Hard "super admin" by email (no password stored here).
      return signedIn() && request.auth.token.email == 'bunkheangheng99@gmail.com';
    }
    function myRole() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid))
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role
        : null;
    }
    function isAdmin() { return signedIn() && (hardAdminByEmail() || myRole() == 'admin'); }
    // Daily plans - public access for authenticated users
    match /daily/{document} {
      allow read, write, delete, create: if request.auth != null;
    }
    
    // Weekly plans - public access for authenticated users
    match /weekly/{document} {
      allow read, write, delete, create: if request.auth != null;
    }
    
    // Monthly plans - public access for authenticated users
    match /monthly/{document} {
      allow read, write, delete, create: if request.auth != null;
    }
    
    // Fitness plans - users can only access their own fitness plans
    match /fitnessPlans/{userId} {
      allow read, write, delete, create: if request.auth != null && request.auth.uid == userId;
    }
    
    // Trading P&L - authenticated users can access
    match /trading_pnl/{document} {
      allow read, write, delete, create: if request.auth != null;
    }
    
    // Projects - authenticated users can access
    match /projects/{document} {
      allow read, write, delete, create: if request.auth != null;
    }
    
    // Business Ideas - authenticated users can access
    match /businessIdeas/{document} {
      allow read, write, delete, create: if request.auth != null;
    }
    
    // Couple Savings - authenticated users can access
    match /coupleSavings/{document} {
      allow read, write, delete, create: if request.auth != null;
      
      // Allow access to entries subcollection
      match /entries/{entryId} {
        allow read, write, delete, create: if request.auth != null;
      }
    }
    
    // User profiles - users can read their own profile, admins can read all
    // Users can create and update their own profile
    match /users/{userId} {
      allow read: if signedIn() && (request.auth.uid == userId || isAdmin());
      // Create: user can create their own profile.
      // - Normal users can only create as restricted/partner.
      // - Hard-admin email can create as admin.
      allow create: if signedIn()
        && request.auth.uid == userId
        && (
          (hardAdminByEmail() && request.resource.data.role == 'admin')
          || (!hardAdminByEmail() && (request.resource.data.role == 'restricted' || request.resource.data.role == 'partner'))
        );

      // Update:
      // - Admin can update any user (including role changes).
      // - Non-admin can update their own doc BUT cannot change role.
      allow update: if signedIn()
        && (
          isAdmin()
          || (
            request.auth.uid == userId
            && request.resource.data.role == resource.data.role
          )
        );
    }

    // Notification settings - users can only access their own settings
    match /notificationSettings/{userId} {
      allow read, write, delete, create: if request.auth != null && request.auth.uid == userId;
    }

    // School Classes - users can only access their own classes
    match /schoolClasses/{docId} {
      allow create: if request.auth != null
        && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if request.auth != null
        && resource.data.userId == request.auth.uid;
    }

    // School Assignments - users can only access their own assignments
    match /schoolAssignments/{docId} {
      allow create: if request.auth != null
        && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if request.auth != null
        && resource.data.userId == request.auth.uid;
    }

    // Trading Partner (shared pool for partner users + admin)
    match /tradingPartnerGroups/{groupId} {
      // Partners can only access groups where they are listed in memberUids.
      // Admins can access all groups and manage partner lists.
      allow read: if signedIn()
        && (isAdmin()
          || (resource.data.memberUids != null && request.auth.uid in resource.data.memberUids));

      allow create: if signedIn()
        && isAdmin()
        && (request.resource.data.memberUids != null && request.auth.uid in request.resource.data.memberUids);

      // Only admins can modify group configuration (members/partners)
      allow update, delete: if signedIn() && isAdmin();

      match /entries/{entryId} {
        // Members (and admins) can read/write entries for their group
        allow read, write, delete, create: if signedIn()
          && (isAdmin()
            || (
              get(/databases/$(database)/documents/tradingPartnerGroups/$(groupId)).data.memberUids != null
              && request.auth.uid in get(/databases/$(database)/documents/tradingPartnerGroups/$(groupId)).data.memberUids
            ));
      }
    }
  }
}